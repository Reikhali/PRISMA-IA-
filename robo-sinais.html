<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prisma IA - Bot de Trading Profissional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background: linear-gradient(180deg, #1a1a2b 0%, #2c2a4a 100%); display: flex; flex-direction: column; align-items: center; min-height: 100vh; color: white; }
        .panel { background-color: rgba(42, 42, 42, 0.5); backdrop-filter: blur(5px); border-radius: 1.5rem; padding: 1.5rem; border: 2px solid #8b5cf6; box-shadow: 0 0 8px rgba(139, 92, 246, 0.7), 0 0 16px rgba(139, 92, 246, 0.5); }
        .btn-primary { padding: 14px 20px; border-radius: 12px; font-weight: 700; color: white; background-color: #22c55e; transition: background-color 0.2s, transform 0.2s; }
        .btn-primary:hover { background-color: #16a34a; transform: translateY(-2px); }
        .btn-secondary { padding: 14px 20px; border-radius: 12px; font-weight: 700; color: white; background-color: #ef4444; transition: background-color 0.2s, transform 0.2s; }
        .btn-secondary:hover { background-color: #dc2626; transform: translateY(-2px); }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: #2a2a2a; } ::-webkit-scrollbar-thumb { background-color: #8b5cf6; border-radius: 4px; }
        .hidden { display: none; }
        .log-item { padding: 0.75rem; border-radius: 0.75rem; }
    </style>
</head>
<body>
    
    <audio id="alert-sound" preload="auto" src="data:audio/mpeg;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU3LjU2LjEwMAAAAAAAAAAAAAAA//tAwAAAAAAAAAAAAAAAAAAAAAAAABoamZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZm/" ></audio>

    <div id="access-key-container" class="min-h-screen flex items-center justify-center p-4 w-full">
        <div class="w-full max-w-md bg-gray-800 bg-opacity-60 backdrop-blur-sm rounded-3xl p-8 shadow-2xl border border-gray-700">
            <h1 class="text-3xl font-bold text-center mb-2">Prisma IA</h1>
            <p class="text-center text-gray-400 mb-6">Chave de Acesso Necessária</p>
            <form id="access-form">
                 <div class="mb-4">
                    <label for="access_key" class="block text-gray-300 text-sm font-bold mb-2">Acesso</label>
                    <input type="text" id="access_key" class="shadow-inner appearance-none border border-gray-600 rounded-lg w-full py-3 px-4 bg-gray-700 text-gray-200 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500" required>
                </div>
                <div class="mb-6">
                    <label for="access_password" class="block text-gray-300 text-sm font-bold mb-2">Senha</label>
                    <input type="password" id="access_password" class="shadow-inner appearance-none border border-gray-600 rounded-lg w-full py-3 px-4 bg-gray-700 text-gray-200 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500" required>
                </div>
                <button id="access-btn" type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition-transform transform hover:scale-105">Entrar</button>
                <p id="access-error" class="text-red-400 text-center mt-4 text-sm h-4"></p>
            </form>
        </div>
    </div>
    
    <div id="login-container" class="min-h-screen flex items-center justify-center p-4 w-full hidden">
        <div class="w-full max-w-md bg-gray-800 bg-opacity-60 backdrop-blur-sm rounded-3xl p-8 shadow-2xl border border-gray-700">
            <h1 class="text-3xl font-bold text-center mb-2">Prisma IA</h1>
            <p class="text-center text-gray-400 mb-6">Faça login com sua conta Exnova</p>
            <form id="login-form">
                 <div class="mb-4">
                    <label for="email" class="block text-gray-300 text-sm font-bold mb-2">Email</label>
                    <input type="email" id="email" class="shadow-inner appearance-none border border-gray-600 rounded-lg w-full py-3 px-4 bg-gray-700 text-gray-200 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-gray-300 text-sm font-bold mb-2">Senha</label>
                    <input type="password" id="password" class="shadow-inner appearance-none border border-gray-600 rounded-lg w-full py-3 px-4 bg-gray-700 text-gray-200 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500" required>
                </div>
                <div class="mb-6">
                    <label for="account_type" class="block text-gray-300 text-sm font-bold mb-2">Tipo de Conta</label>
                    <select id="account_type" class="shadow-inner appearance-none border border-gray-600 rounded-lg w-full py-3 px-4 bg-gray-700 text-gray-200 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <option value="PRACTICE">Conta de Treinamento</option>
                        <option value="REAL">Conta Real</option>
                    </select>
                </div>
                <button id="login-btn" type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition-transform transform hover:scale-105">Conectar</button>
                <p id="login-error" class="text-red-400 text-center mt-4 text-sm h-4"></p>
            </form>
        </div>
    </div>
    
    <div id="app-container" class="container mx-auto p-4 md:p-8 hidden">
        <header class="flex items-center justify-between mb-8">
            <div class="flex-1 flex items-center justify-center">
                <h1 class="text-5xl font-bold tracking-wider">Prisma IA</h1>
            </div>
            <div class="bg-gray-800 bg-opacity-70 p-4 rounded-xl flex items-center shadow-lg border border-purple-500/30">
                <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse mr-2"></div>
                <div class="text-lg">Saldo: <span id="balance-display" class="font-bold text-green-400">0.00 USD</span></div>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <section class="space-y-8">
                <div class="panel">
                    <h2 class="text-2xl font-semibold mb-6">Controle do Robô</h2>
                    <div class="space-y-6">
                        <div>
                            <label for="timeframe-select" class="block text-gray-300 mb-2">Timeframe de Análise</label>
                            <select id="timeframe-select" class="w-full bg-gray-700 border border-gray-600 rounded-lg py-3 px-4 text-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="1">M1</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-300 mb-2">Estratégia</label>
                            <select id="automation-select" class="w-full bg-gray-700 border border-gray-600 rounded-lg py-3 px-4 text-gray-200 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500" disabled>
                                <option value="jogo_sujo">JOGO SUJO</option>
                            </select>
                        </div>
                        <div class="flex justify-around gap-4 pt-4">
                            <button id="start-btn" class="w-full btn-primary">Iniciar Robô</button>
                            <button id="stop-btn" class="w-full btn-secondary">Parar Robô</button>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <h2 class="text-2xl font-semibold mb-4">Alerta de Sinal</h2>
                    <div id="signals-output" class="h-80 overflow-y-auto bg-black bg-opacity-30 rounded-xl p-4 space-y-2 flex flex-col justify-center items-center">
                         <div id="no-signal-message" class="text-gray-400 text-sm">Nenhum sinal encontrado. Aguardando...</div>
                         <div id="signal-display" class="hidden">
                            <div class="flex flex-col items-center"><p class="text-gray-400">Par de Moeda</p><p id="signal-pair" class="text-xl font-bold"></p></div>
                            <div class="flex flex-col items-center mt-4"><p class="text-gray-400">Direção Potencial</p><p id="signal-direction" class="text-3xl font-bold"></p></div>
                            <div class="flex flex-col items-center mt-4"><p class="text-gray-400">Padrão Identificado</p><p id="signal-pattern" class="text-2xl font-bold text-yellow-400"></p></div>
                            <div class="flex flex-col items-center mt-4"><p class="text-gray-400">Entrar na Abertura da Próxima Vela</p><p id="signal-time" class="text-lg font-semibold text-gray-300"></p></div>
                        </div>
                    </div>
                </div>
            </section>

            <aside class="space-y-8">
                <div class="panel">
                    <h2 class="text-2xl font-semibold mb-4">Estatísticas</h2>
                    <div class="grid grid-cols-2 gap-4 text-center">
                        <div class="bg-gray-700 p-4 rounded-xl"><p class="text-sm text-gray-400">Entradas</p><p id="total-trades" class="text-2xl font-bold">0</p></div>
                        <div class="bg-gray-700 p-4 rounded-xl flex flex-col justify-center items-center"><p class="text-sm text-gray-400">Assertividade da Análise</p><p id="win-rate" class="text-4xl font-bold text-purple-400">--%</p></div>
                    </div>
                </div>
                <div class="panel">
                    <h2 class="text-2xl font-semibold mb-4">Logs de Atividades</h2>
                    <div id="log-output" class="h-80 overflow-y-auto bg-black bg-opacity-30 rounded-xl p-4 space-y-2"><p class="text-gray-400 text-sm">Aguardando início do robô...</p></div>
                </div>
            </aside>
        </main>
    </div>
    
    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-gray-800 rounded-xl p-6 shadow-2xl max-w-sm w-full border border-gray-700">
            <h3 id="modal-title" class="text-xl font-bold mb-4">Aviso</h3>
            <p id="modal-message" class="text-gray-300 mb-6"></p>
            <button id="close-modal-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg">Fechar</button>
        </div>
    </div>
    
    <script>
        const API_URL = 'http://127.0.0.1:5000';
        let PAIRS = []; let intervalId = null; let signalCountdownInterval = null;
        const state = { isBotRunning: false, pairData: {}, currentBalance: 0, currency: '', timeframe: 1, trades: { wins: 0, losses: 0, total: 0 } };
        function showApp() { document.getElementById('login-container').classList.add('hidden'); document.getElementById('app-container').classList.remove('hidden'); }
        function log(message, type = 'info') { const logElement = document.getElementById('log-output'); if (!logElement) return; const logDiv = document.createElement('div'); const timestamp = new Date().toLocaleTimeString('pt-BR', { hour12: false }); logDiv.classList.add('log-item'); let colorClass = 'bg-gray-700'; if (type === 'success') colorClass = 'bg-green-600'; if (type === 'error') colorClass = 'bg-red-600'; if (type === 'info') colorClass = 'bg-blue-900'; logDiv.classList.add(colorClass); logDiv.innerHTML = `<span class="font-bold">[${timestamp}]</span> ${message}`; logElement.prepend(logDiv); if (logElement.children.length > 50) logElement.lastChild.remove(); }
        function updateStats() { document.getElementById('total-trades').textContent = state.trades.total; }
        
        function displaySignal(pairName, direction, pattern, entryTime, timeToTrade) {
            document.getElementById('no-signal-message').classList.add('hidden');
            document.getElementById('signal-display').classList.remove('hidden');
            const directionColor = direction === 'CALL' ? 'text-green-500' : 'text-red-500';
            const directionIcon = direction === 'CALL' ? '⬆️' : '⬇️';
            document.getElementById('signal-pair').textContent = pairName;
            document.getElementById('signal-direction').textContent = `${direction} ${directionIcon}`;
            document.getElementById('signal-direction').classList.remove('text-green-500', 'text-red-500');
            document.getElementById('signal-direction').classList.add(directionColor);
            document.getElementById('signal-pattern').textContent = pattern;
            document.getElementById('signal-time').innerHTML = `Às ${entryTime} <span class="text-purple-400 font-semibold">(${timeToTrade}s)</span> ⏳`;
            
            const alertSound = document.getElementById('alert-sound');
            if (alertSound) {
                alertSound.currentTime = 0;
                alertSound.play().catch(error => { console.warn("A reprodução do áudio foi bloqueada pelo navegador.", error); });
            }
        }

        function clearSignalDisplay() { clearInterval(signalCountdownInterval); document.getElementById('no-signal-message').classList.remove('hidden'); document.getElementById('signal-display').classList.add('hidden'); }
        function showModal(title, message) { const modalTitle = document.getElementById('modal-title'); const modalMessage = document.getElementById('modal-message'); const modalBackdrop = document.getElementById('modal-backdrop'); if(modalTitle) modalTitle.textContent = title; if(modalMessage) modalMessage.textContent = message; if(modalBackdrop) modalBackdrop.classList.remove('hidden'); }

        /**************************************************************************
         * 
         * ESTRATÉGIA JOGO SUJO
         * Combinação de Probabilidade, Fractais, Vortex e Tendência.
         * 
         **************************************************************************/

        const calculate = {
            sma: (data, period) => { let r = [], s; for (let i = period - 1; i < data.length; i++) { s = 0; for (let j = 0; j < period; j++) s += data[i - j]; r.push(s / period); } return r; },
            
            vortex: (candles, period) => {
                let tr_arr = [], vp_arr = [], vm_arr = [];
                for(let i = 1; i < candles.length; i++) {
                    const high = candles[i].high, low = candles[i].low, prevClose = candles[i-1].close;
                    const prevHigh = candles[i-1].high, prevLow = candles[i-1].low;
                    tr_arr.push(Math.max(high - low, Math.abs(high - prevClose), Math.abs(low - prevClose)));
                    vp_arr.push(Math.abs(high - prevLow));
                    vm_arr.push(Math.abs(low - prevHigh));
                }
                let viPlus = [], viMinus = [];
                for (let i = period - 1; i < tr_arr.length; i++) {
                    let tr_sum = 0, vp_sum = 0, vm_sum = 0;
                    for(let j=0; j < period; j++) {
                        tr_sum += tr_arr[i - j];
                        vp_sum += vp_arr[i - j];
                        vm_sum += vm_arr[i - j];
                    }
                    if (tr_sum === 0) { viPlus.push(0); viMinus.push(0); }
                    else { viPlus.push(vp_sum / tr_sum); viMinus.push(vm_sum / tr_sum); }
                }
                return { viPlus: viPlus, viMinus: viMinus };
            },

            findRecentFractal: (candles, lookback = 5) => {
                for (let i = candles.length - 3; i >= candles.length - 2 - lookback; i--) {
                    if (i < 2) continue;
                    
                    const isBearishFractal = candles[i].high > candles[i-1].high && candles[i].high > candles[i-2].high &&
                                             candles[i].high > candles[i+1].high && candles[i].high > candles[i+2].high;
                    if (isBearishFractal) return 'BEARISH';
                    
                    const isBullishFractal = candles[i].low < candles[i-1].low && candles[i].low < candles[i-2].low &&
                                             candles[i].low < candles[i+1].low && candles[i].low < candles[i+2].low;
                    if (isBullishFractal) return 'BULLISH';
                }
                return null;
            },

            getBreakoutBias: (candles, lookback = 100) => {
                if (candles.length < lookback + 2) return null;
                const historicalCandles = candles.slice(0, candles.length - 2);
                
                let greenCandlesTotal = 0, redCandlesTotal = 0;
                let greenHitsHigh = 0, greenHitsLow = 0;
                let redHitsHigh = 0, redHitsLow = 0;

                for (let i = 0; i < historicalCandles.length -1; i++) {
                    const prevCandle = historicalCandles[i];
                    const currentCandle = historicalCandles[i+1];

                    if (prevCandle.close > prevCandle.open) {
                        greenCandlesTotal++;
                        if (currentCandle.high >= prevCandle.high) greenHitsHigh++;
                        if (currentCandle.low <= prevCandle.low) greenHitsLow++;
                    } else if (prevCandle.close < prevCandle.open) {
                        redCandlesTotal++;
                        if (currentCandle.high >= prevCandle.high) redHitsHigh++;
                        if (currentCandle.low <= prevCandle.low) redHitsLow++;
                    }
                }

                const prevAnalysisCandle = candles[candles.length - 2];
                if (prevAnalysisCandle.close > prevAnalysisCandle.open) {
                    if (greenCandlesTotal === 0) return null;
                    const probHigh = greenHitsHigh / greenCandlesTotal;
                    const probLow = greenHitsLow / greenCandlesTotal;
                    return probHigh > probLow ? 'BULLISH' : 'BEARISH';
                } else if (prevAnalysisCandle.close < prevAnalysisCandle.open) {
                    if (redCandlesTotal === 0) return null;
                    const probHigh = redHitsHigh / redCandlesTotal;
                    const probLow = redHitsLow / redCandlesTotal;
                    return probHigh > probLow ? 'BULLISH' : 'BEARISH';
                }
                return null;
            }
        };

        async function checkStrategyAndGenerateSignal(pairName) {
            const candles = state.pairData[pairName].candles;
            if (candles.length < 120) return null; 

            const lastCandle = candles[candles.length - 1];
            if (state.pairData[pairName].lastSignalTimestamp === lastCandle.from) return null;

            const closePrices = candles.map(c => c.close);
            
            const sma50 = calculate.sma(closePrices, 50).pop();
            const currentPrice = closePrices[closePrices.length - 1];
            const trend = currentPrice > sma50 ? 'UP' : 'DOWN';

            const bias = calculate.getBreakoutBias(candles, 100);

            const vortex2 = calculate.vortex(candles, 2);
            const vPlus = vortex2.viPlus.pop();
            const vMinus = vortex2.viMinus.pop();
            const vortexConfirmation = vPlus > vMinus ? 'BULLISH' : 'BEARISH';

            const fractal = calculate.findRecentFractal(candles, 5);

            let signal = null;

            if (trend === 'UP' && bias === 'BULLISH' && vortexConfirmation === 'BULLISH' && fractal === 'BULLISH') {
                 log(`SINAL DE CALL em ${pairName}! Gatilhos JOGO SUJO confirmados.`, 'success');
                 signal = { pair: pairName, direction: 'CALL', pattern: 'JOGO SUJO - Alta', timestamp: lastCandle.from };
            }
            
            if (trend === 'DOWN' && bias === 'BEARISH' && vortexConfirmation === 'BEARISH' && fractal === 'BEARISH') {
                 log(`SINAL DE PUT em ${pairName}! Gatilhos JOGO SUJO confirmados.`, 'success');
                 signal = { pair: pairName, direction: 'PUT', pattern: 'JOGO SUJO - Baixa', timestamp: lastCandle.from };
            }

            if(signal) {
                state.pairData[pairName].lastSignalTimestamp = lastCandle.from;
                return signal;
            }

            return null;
        }


        /**************************************************************************
         * FIM DA ÁREA DA ESTRATÉGIA
         **************************************************************************/
        
        function simulateTradeResult(signal) { setTimeout(() => { state.trades.total++; if (Math.random() < 0.5) state.trades.losses++; else state.trades.wins++; updateStats(); }, (2 * 60 * 1000) + 2000); }
        async function connectToAPI() { log('Iniciando conexão...', 'info'); const email = document.getElementById('email').value; const password = document.getElementById('password').value; const account_type = document.getElementById('account_type').value; try { const response = await fetch(`${API_URL}/api/connect`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email: email, senha: password, account_type: account_type }) }); const data = await response.json(); if (response.ok) { state.currentBalance = data.balance; state.currency = data.currency; document.getElementById('balance-display').textContent = `${state.currentBalance.toFixed(2)} ${state.currency}`; log(`Conectado com sucesso à conta ${account_type}! Saldo: ${state.currentBalance.toFixed(2)} ${state.currency}`, 'success'); showApp(); updateStats(); } else { log(`Erro de conexão: ${data.error}`, 'error'); document.getElementById('login-error').textContent = data.error; } } catch (error) { log(`Falha na conexão com o servidor: ${error.message}`, 'error'); document.getElementById('login-error').textContent = "Falha na conexão com o servidor. Verifique se o app.py está rodando."; } }
        async function fetchOpenPairs() { try { const response = await fetch(`${API_URL}/api/open-pairs`); if (!response.ok) throw new Error('Não foi possível buscar os pares.'); const pairsData = await response.json(); PAIRS = pairsData.filter(p => p.payout >= 85).sort((a, b) => b.payout - a.payout); if (PAIRS.length === 0) { log('Nenhum par com payout de 85% ou mais foi encontrado.', 'error'); showModal('Aviso', 'Nenhum par com bom payout (>85%) foi encontrado no momento.'); return false; } else { log(`Encontrados ${PAIRS.length} pares com payout >= 85%. O melhor é ${PAIRS.length > 0 ? PAIRS[0].name : ''} com ${PAIRS.length > 0 ? PAIRS[0].payout : ''}%`); } state.pairData = {}; return true; } catch (error) { log(`Erro ao buscar pares: ${error.message}`, 'error'); showModal('Erro', 'Não foi possível carregar a lista de pares da Exnova.'); return false; } }
        async function searchForSignal() { log('Buscando por sinais...', 'info'); let signalFoundThisRound = false; for (const pair of PAIRS) { try { const encodedPairName = encodeURIComponent(pair.name); const response = await fetch(`${API_URL}/api/candles/${encodedPairName}/${state.timeframe}?count=300`); if (!response.ok) continue; const candlesData = await response.json(); if (!candlesData || candlesData.length === 0) continue; const candles = candlesData.map(c => ({ open: c.open, high: c.max, low: c.min, close: c.close, from: c.from, volume: c.volume })); if(!state.pairData[pair.name]) { state.pairData[pair.name] = { candles: [], lastSignalTimestamp: null }; } state.pairData[pair.name].candles = candles; const signal = await checkStrategyAndGenerateSignal(pair.name); if (signal) { signalFoundThisRound = true; const entryTimestamp = (signal.timestamp + state.timeframe * 60) * 1000; const entryTime = new Date(entryTimestamp); const entryTimeString = entryTime.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }); clearInterval(signalCountdownInterval); signalCountdownInterval = setInterval(() => { const currentTime = new Date().getTime(); let timeToTrade = Math.ceil((entryTimestamp - currentTime) / 1000); if (timeToTrade > 0 && timeToTrade <= (state.timeframe * 60)) { displaySignal(signal.pair, signal.direction, signal.pattern, entryTimeString, timeToTrade); } else { clearSignalDisplay(); log(`Tempo de preparação para ${signal.pair} expirou.`, 'info'); } }, 1000); simulateTradeResult(signal); return; } } catch (error) { log(`Erro ao processar ${pair.name}: ${error.message}`, 'error'); } } if (!signalFoundThisRound && state.isBotRunning) { log('Nenhum sinal que atenda aos filtros foi encontrado.', 'info'); clearSignalDisplay(); } }
        async function startAutoSignalSearch() { if (state.isBotRunning) return; state.isBotRunning = true; document.getElementById('start-btn').disabled = true; document.getElementById('stop-btn').disabled = false; state.timeframe = parseInt(document.getElementById('timeframe-select').value); log('Iniciando Robô Prisma IA...', 'success'); const pairsFetched = await fetchOpenPairs(); if (pairsFetched) { searchForSignal(); intervalId = setInterval(() => { const now = new Date(); if (now.getSeconds() === 1) { searchForSignal(); } }, 1000); } else { state.isBotRunning = false; document.getElementById('start-btn').disabled = false; document.getElementById('stop-btn').disabled = true; } }
        function stopAutoSignalSearch() { if (!state.isBotRunning) return; state.isBotRunning = false; clearInterval(intervalId); clearSignalDisplay(); document.getElementById('start-btn').disabled = false; document.getElementById('stop-btn').disabled = true; log('Robô parado pelo usuário.', 'error'); }
        
        document.getElementById('access-form').addEventListener('submit', function(event) {
            event.preventDefault();
            const accessKey = document.getElementById('access_key').value;
            const accessPassword = document.getElementById('access_password').value;
            const accessError = document.getElementById('access-error');
            const correctAccess = 'insta-tal_do_khali';
            const correctPassword = '70721472';
            if (accessKey === correctAccess && accessPassword === correctPassword) {
                document.getElementById('access-key-container').classList.add('hidden');
                document.getElementById('login-container').classList.remove('hidden');
            } else {
                accessError.textContent = 'Acesso ou Senha inválidos.';
            }
        });

        document.getElementById('login-form').addEventListener('submit', function(event) { event.preventDefault(); connectToAPI(); });
        document.getElementById('start-btn').addEventListener('click', startAutoSignalSearch);
        document.getElementById('stop-btn').addEventListener('click', stopAutoSignalSearch);
        document.getElementById('close-modal-btn').addEventListener('click', () => { document.getElementById('modal-backdrop').classList.add('hidden'); });
        window.onload = function() { document.getElementById('stop-btn').disabled = true; log('Aguardando início do robô...'); }
    </script>
</body>
</html>